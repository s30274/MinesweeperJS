<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/ed8f9c16b4.js" crossorigin="anonymous"></script>
</head>
<body>
<div id="saper-app" class="container mx-auto lg:max-w-[70%] sm:max-w-[100%] px-4 bg-gray-100 pb-5"></div>

<script>
    // =============================== < Z M I E N N E > =====================================


    const numberColors = ['blue-600', 'green-600', 'red-600', 'indigo-700', 'red-950', 'cyan-600', 'black', 'gray-700'];
    const localStorage = [
        { difficulty: 'easy', time: 50 },
        { difficulty: 'easy', time: 250 },
        { difficulty: 'easy', time: 350 },
        { difficulty: 'easy', time: 300 },
        { difficulty: 'easy', time: 240 },
        { difficulty: 'hard', time: 250 },
        { difficulty: 'expert', time: 250 },

    ];
    let cells = [];
    let discovered = [];
    let flags;
    let startArguments = [31, 6, 10];


    // =================================== < D O M > =========================================

    document.addEventListener('DOMContentLoaded', () => {


        // =========================== < F U N K C J E > =====================================


        const appContainer = document.getElementById('saper-app');
        if (!appContainer) {
            console.error("Nie znaleziono kontenera #saper-app");
            return;
        }

        // Funkcje pomocnicze
        function createElement(tag, classNames = [], textContent = '') {
            const element = document.createElement(tag);
            if (classNames.length > 0) {
                element.className = classNames.join(' ');
            }
            if (textContent) {
                element.textContent = textContent;
            }
            return element;
        }


        function increaseTimer() {
            const timerElement = document.getElementById('timer');
            const time = parseInt(timerElement.textContent) + 1;
            timerElement.textContent = formatThreeDigit(time);
        }


        function formatThreeDigit(number) {
            let prefix = '';
            if(number < 10) {
                prefix = '00';
            } else if (number < 100) {
                prefix = '0';
            }
            return prefix + number;
        }


        function fillCells(width, height, bombAmount) {
            cells = [];
            let bombs = [];
            let area = width * height;

            // Generating bombs
            while(bombs.length < bombAmount) {
                const randomNumber = Math.floor(Math.random() * area);
                if(!bombs.includes(randomNumber)) bombs.push(randomNumber);
            }

            // Planting bombs
            for (let i = 0; i < area; i++) {
                bombs.includes(i) ? cells[i] = 9 : cells[i] = 0;
                discovered[i] = false;
            }

            // Generating hints
            bombs.forEach(position => {
                execAround(width, height, position, incrementCell);
            });
        }


        function execAround(width, height, index, func) {
            let left = true, right = true, up = true, down = true;
            if ((index - 1) % width === (width - 1) || (index - 1) % width < 0) left = false;
            if ((index + 1) % width === 0) right = false;
            if (index < width) up = false;
            if (index >= width * (height-1)) down = false;

            if (left) {
                if(up) func(width, height, index-width-1);
                func(width, height, index-1);
                if(down) func(width, height, index+width-1);
            }

            if(up) func(width, height, index-width);
            if (down) func(width, height, index + width);

            if (right) {
                if(up) func(width, height, index-width+1);
                func(width, height, index+1);
                if(down) func(width, height, index+width+1);
            }
        }


        function incrementCell(width, height, position) {
            cells[position]++;
        }


        function showBombs(index) {
            cells.forEach((value, i) => {
                if(value < 0 && value > -10){
                    document.getElementById(i.toString()).classList.replace('bg-gray-500', 'bg-red-700');
                } else if (value >= 9 && i !== index){
                    const cell = document.getElementById(i.toString());
                    cell.classList.replace('bg-gray-500', 'bg-gray-300');
                    cell.appendChild(createElement('i', ['fa-solid', 'fa-bomb', 'text-xl']));
                }
            })
        }


        function flag(index) {
            cells[index] = (-1 * cells[index]) - 1;
            flags -= 1;
            document.getElementById(index).appendChild(createElement('i', ['fa-solid', 'fa-flag', 'text-xl']));
            document.getElementById('flagCounter').textContent = formatThreeDigit(flags);
            return cells[index];
        }


        function unflag(index) {
            cells[index] = (-1 * cells[index]) - 1;
            flags += 1;
            document.getElementById(index).innerHTML = '';
            document.getElementById('flagCounter').textContent = formatThreeDigit(flags);
            return cells[index];
        }


        function discover(index) {
            if(cells[index] >= 0 && discovered[index] === false) {

                discovered[index] = true;

                if(cells[index] === 0) {
                    document.getElementById(index).classList.replace('bg-gray-500', 'bg-gray-300');

                } else if(cells[index] > 0 && cells[index] < 9) {
                    const cell = document.getElementById(index);
                    cell.classList.replace('bg-gray-500', 'bg-gray-300');
                    cell.appendChild(createElement('p', ['text-xl', 'font-bold', `text-${numberColors[cells[index]-1]}`], cells[index]));

                } else if(cells[index] >= 9) {
                    const cell = document.getElementById(index);
                    cell.classList.replace('bg-gray-500', 'bg-red-500');
                    cell.appendChild(createElement('i', ['fa-solid', 'fa-bomb', 'text-xl']));
                }
            }
        }


        function discoverArea(width, height, index) {
            if(discovered[index] === false) {

                if(cells[index] < 0) {
                    unflag(index);
                }

                if(cells[index] < 9) {
                    discover(index);
                }

                if(cells[index] === 0) {
                    execAround(width, height, index, discoverArea);
                }
            }
        }


        function discoveredAmount() {
            return discovered.reduce((acc, value) => value === true ? acc + 1 : acc, 0);
        }


        function saveTime(difficulty) {
            if(difficulty !== 'custom') {
                localStorage.push({difficulty: 'easy', time: parseInt(document.getElementById('timer').textContent) });
                let timetable = localStorage.filter((record) => record.difficulty === 'easy');
                timetable.sort((a, b) => (a.time > b.time) ? 1 : (a.time < b.time) ? -1 : 0);
                if(timetable.length > 5) {
                    localStorage.splice(localStorage.indexOf(timetable.pop()), 1);
                }
            }
        }


        function updateScoreTable(difficulty) {
            const scoreTable = document.getElementById('scoreTable');
            scoreTable.innerHTML = '';

            if(difficulty !== 'custom') {
                const header = createElement('thead', []);
                const headRecord = createElement('tr', []);
                headRecord.appendChild(createElement('th', ['text-left'], 'Difficulty'));
                headRecord.appendChild(createElement('th', ['text-right'], 'Time'));
                header.appendChild(headRecord);
                scoreTable.appendChild(header);

                const body = createElement('tbody', []);
                localStorage.filter((record) => record.difficulty === 'easy')
                    .sort((a, b) => (a.time > b.time) ? 1 : (a.time < b.time) ? -1 : 0)
                    .forEach((score) => {
                        console.log(score);
                        const tr = createElement('tr', '');
                        tr.appendChild(createElement('td', ['text-left'], score.difficulty));
                        tr.appendChild(createElement('td', ['text-right'], score.time));
                        body.appendChild(tr);
                    });
                scoreTable.appendChild(body);
            }
        }


        function getDifficulty(width, height, bombAmount) {
            if(width === 9 && height === 9 && bombAmount === 10) {
                return 'easy';
            } else if(width === 16 && height === 16 && bombAmount === 40) {
                return 'hard';
            } else if(width === 30 && height === 16 && bombAmount === 99) {
                return 'expert';
            } else {
                return 'custom';
            }
        }


        // ============================ < H E A D E R > ======================================


        // Tworzenie Nagłówka Aplikacji
        const header = createElement('header', ['flex', 'flex-col', 'text-center']);
        const mainTitle = createElement('h1', ['rounded-xl', 'bg-blue-600', 'py-4', 'text-center', 'text-white', 'text-2xl', 'font-bold', 'shadow', 'mt-5', 'mb-10'], 'Super Saper 3000');
        header.appendChild(mainTitle);
        appContainer.appendChild(header);


        // =========================== < C O N T E N T > =====================================


        const settings = createElement('div', ['flex', 'flex-row', 'text-left', 'rounded-md', 'bg-white', 'p-5', 'mb-10']);
        const container = createElement('div', ['w-full', 'flex', 'flex-col', 'flex-nowrap', 'justify-between', 'items-center']);
        const stats = createElement('div', ['flex', 'flex-row', 'bg-white', 'p-2', 'mb-4']);

        const flagCounter = createElement('p', ['text-lg'], '000');
        flagCounter.id = 'flagCounter';
        stats.appendChild(flagCounter);

        const face = createElement('i', ['fa-solid', 'fa-face-smile', 'text-2xl']);
        face.id = 'face';
        face.onclick = () => {
            startGame(startArguments[0], startArguments[1], startArguments[2]);
        }
        stats.appendChild(face);

        const timer = createElement('p', ['text-lg'], '000');
        timer.id = 'timer';
        stats.appendChild(timer);
        container.appendChild(stats);

        const saper = createElement('div', []);
        saper.id = 'saper';



        function startGame(width, height, bombAmount) {

            const saper = document.getElementById('saper');
            let over = false;
            let first = true;
            let timerVar;
            flags = bombAmount;
            document.getElementById('flagCounter').textContent = formatThreeDigit(flags);
            fillCells(width, height, bombAmount);
            const difficulty = getDifficulty(width, height, bombAmount);
            updateScoreTable(difficulty);
            saper.className = `w-full flex flex-col flex-nowrap justify-center 2xl:items-${width > 30 ? 'left' : 'center'} xl:items-${width > 25 ? 'left' : 'center'} lg:items-${width > 22 ? 'left' : 'center'} md:items-${width > 15 ? 'left' : 'center'} sm:items-${width > 12 ? 'left' : 'center'} items-${width > 9 ? 'left' : 'center'} gap-1 mb-10`;
            saper.innerHTML = '';
            let row = createElement('div', ['flex', 'flex-row', 'flex-nowrap', 'gap-1']);

            cells.forEach((cell, index) => {
                const element = createElement('div', ['size-12', 'lg:size-8', 'aspect-square', 'flex', 'flex-col', 'bg-gray-500', 'rounded-md', 'text-center', 'justify-center']);
                element.id = index.toString();

                // FLAG
                element.addEventListener('contextmenu', function(e) {
                    if(!over) {
                        if (flags > 0 && cell >= 0 && !discovered[index]) {
                            cell = flag(index);
                        } else if (cell < 0) {
                            cell = unflag(index);
                        }
                    }
                    e.preventDefault();
                }, false);

                // DISCOVER
                element.onclick = () => {
                    if(first) {
                        timerVar = setInterval(increaseTimer, 1000);
                        first = false;
                    }

                    if(!over && !discovered[index]) {

                        if (cell === 0) {
                            discoverArea(width, height, index);
                        } else {
                            discover(index);
                        }

                        if (cell >= 9) {
                            showBombs(index);
                            clearInterval(timerVar);
                            document.getElementById('face').classList.replace('fa-face-smile', 'fa-face-dizzy');
                            over = true;
                        }

                        if(discoveredAmount() === width*height-bombAmount && over === false) {
                            document.getElementById('face').classList.replace('fa-face-smile', 'fa-face-laugh-beam');
                            clearInterval(timerVar);
                            saveTime(difficulty);
                            updateScoreTable(difficulty);
                            over = true;
                        }
                    }
                }


                row.appendChild(element);
                if(index % width === (width-1)){
                    saper.appendChild(row);
                    row = createElement('div', ['flex', 'flex-row', 'flex-nowrap', 'gap-1']);
                }
            });
        }

        container.appendChild(saper);

        const scoreTable = createElement('table', ['bg-white', 'p-5', 'rounded-mb']);
        scoreTable.id = 'scoreTable';
        container.appendChild(scoreTable);

        appContainer.appendChild(container);

        // ============================ < R E N D E R > ======================================


        startGame(startArguments[0], startArguments[1], startArguments[2]);


        // ============================ < S T O P K A > ======================================


        const footer = createElement('footer', ['text-center', 'text-xs', 'text-gray-500', 'mt-10', 'pt-5', 'border-t']);
        footer.innerHTML = `&copy; 2025 Saper s30274`;
        appContainer.appendChild(footer);

    });

</script>

</body>
</html>